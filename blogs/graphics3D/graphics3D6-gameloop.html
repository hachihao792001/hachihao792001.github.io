<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@200&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/blogcontent.css">
    <link rel="stylesheet" href="/css/prism.css">
    <link rel="stylesheet" href="graphics3D.css">

    <script src="/js/prism.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <title>Graphics Engine 3D</title>
</head>

<body data-graphics3D-id="graphics3D6">
    <main>
        <div class="container-fluid ps-0">
            <div class="row">
                <div class="col-12 col-lg-2 sidebar pb-0 pe-0">
                    <!--load from sidebar.html-->
                </div>

                <div class="blog-content col-12 col-lg-10">
                    <div id="graphics3D-nav-top"></div>
                    <h1>Game loop vÃ  face culling</h1>
                    
                    Tá»« blog Ä‘áº§u tiÃªn tá»›i giá» ta chá»‰ cÃ³ táº¡o vÃ  hiá»ƒn thá»‹ object lÃªn mÃ n hÃ¬nh, nhÆ°ng chÃºng khÃ´ng há» di chuyá»ƒn, khÃ¡ chÃ¡n.
                    Cho nÃªn blog nÃ y ta sáº½ cÃ i Ä‘áº·t má»™t há»‡ thá»‘ng Game loop, nÃ³i nÃ´m na lÃ  cáº­p nháº­t frame theo thá»i gian má»™t cÃ¡ch á»•n Ä‘á»‹nh. Blog nÃ y sáº½ khÃ¡ ngáº¯n vÃ  dá»…
                    hiá»ƒu, lÃ  má»™t breath of fresh air sau vÃ i blog náº·ng vá» toÃ¡n vá»«a rá»“i ğŸ¥µ<br/><br/>

                    Äáº§u tiÃªn báº¡n nÃªn biáº¿t lÃ  khÃ´ng cÃ³ mÃ¡y tÃ­nh nÃ o cÃ³ tá»‘c Ä‘á»™ xá»­ lÃ½ giá»‘ng nhau, náº¿u báº¡n lÃ m game mÃ  khÃ´ng Ä‘á»ƒ Ã½ tá»›i fact Ä‘Ã³, thÃ¬ nÃ³ sáº½ bá»‹ hiá»‡n tÆ°á»£ng
                    slow motion trÃªn mÃ¡y cháº­m, vÃ  cháº¡y nhÆ° flash trÃªn mÃ¡y nhanh, Ä‘iá»ƒn hÃ¬nh lÃ  Dark souls remastered bá»‹ váº¥n Ä‘á» nÃ y (báº£n cÅ© thÃ¬ khÃ´ng bá»‹). VÃ­ dá»¥ Ä‘Æ¡n giáº£n vá»›i
                    vá»‹ trÃ­ cá»§a object, lÃ½ do xáº£y ra váº¥n Ä‘á» trÃªn lÃ  má»i frame báº¡n Ä‘á»u cá»™ng 1 khoáº£ng giá»‘ng nhau, mÃ¡y nhanh xá»­ lÃ½ xong 1 frame trong 0.03s báº¡n cá»™ng 2m, mÃ¡y cháº­m
                    xá»­ lÃ½ xong 1 frame trong 0.07s báº¡n cÅ©ng cá»™ng 2m, thÃ¬ táº¥t nhiÃªn lÃ  nÃ³ sáº½ bá»‹ cháº¡y cháº­m hÆ¡n trÃªn mÃ¡y cháº­m vÃ  nhanh hÆ¡n trÃªn mÃ¡y nhanh. Náº¿u ngÃ y xÆ°a báº¡n tá»«ng 
                    lÃ m game console báº±ng C++, báº¡n sáº½ gáº·p qua váº¥n Ä‘á» nÃ y khi cá»© cá»™ng khoáº£ng y há»‡t má»—i vÃ²ng láº·p while loop ğŸ˜….<br/><br/>
                    
                    CÃ¡ch giáº£i quyáº¿t váº¥n
                    Ä‘á» nÃ y khÃ¡ dá»…, báº¡n chá»‰ cáº§n Ä‘áº·t clock Ä‘áº¿m xem frame trÆ°á»›c xá»­ lÃ½ xong trong bao lÃ¢u (khoáº£ng thá»i gian nÃ y Ä‘Æ°á»£c gá»i lÃ  delta time (\(\Delta t\))),
                    rá»“i sau Ä‘Ã³ cá»™ng khoáº£ng phÃ¹ há»£p vá»›i \(\Delta t\): frame trÆ°á»›c xong trong 0.03s thÃ¬ cá»™ng 2 * 0.03 m, frame trÆ°á»›c xong trong 0.07s thÃ¬ cá»™ng 2 * 0.07m 
                    (máº¥t thá»i gian lÃ¢u hÆ¡n Ä‘á»ƒ xá»­ lÃ½ thÃ¬ cho di chuyá»ƒn xa hÆ¡n Ä‘á»ƒ bÃ¹ láº¡i khoáº£ng thá»i gian Ä‘Ã³). 
                    NhÆ° váº­y sáº½ giáº£i quyáº¿t Ä‘Æ°á»£c váº¥n Ä‘á» slow motion, nhÆ°ng bÃ¢y giá» vá»‹ trÃ­ váº­t trÃªn mÃ¡y cháº­m sáº½ bá»‹ giáº­t giáº­t, nhÆ°ng mÃ  váº«n Ä‘áº£m báº£o váº­t sáº½ luÃ´n á»Ÿ chung vá»‹ trÃ­ vá»›i 
                    mÃ¡y nhanh.<br/><br/>

                    Äá»ƒ Ä‘áº¿m thá»i gian trong javascript khÃ¡ dá»…, ta chá»‰ cáº§n xÃ i <a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance/now">performance.now()</a>,
                    lÃ  hÃ m Ä‘áº¿m sá»‘ mili giÃ¢y tá»« ká»ƒ tá»« <a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance/timeOrigin">Performance.timeOrigin</a>.
                    Äá»‘i vá»›i loop frame thÃ¬ sá»­ dá»¥ng hÃ m 
                    <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/requestAnimationFrame">requestAnimationFrame()</a>, lÃ  hÃ m yÃªu cáº§u browser gá»i má»™t hÃ m
                    callback trÆ°á»›c láº§n váº½ káº¿ tiáº¿p, hÃ m callback Ä‘Ã³ pháº£i cÃ³ tham sá»‘ Ä‘áº§u tiÃªn lÃ  má»™t biáº¿n Ä‘áº¡i diá»‡n cho sá»‘ mili giÃ¢y ká»ƒ tá»« <a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance/timeOrigin">timeOrigin</a>,
                    chÃ­nh lÃ  thá»© mÃ  ta vá»«a nÃ³i tá»›i. Ta sáº½ táº¡o má»™t hÃ m update, vÃ  á»Ÿ cuá»‘i hÃ m ta dÃ¹ng requestAnimationFrame Ä‘á»ƒ gá»i callback lÃ  chÃ­nh nÃ³ 
                    (Ä‘á»«ng lo, nÃ³ khÃ´ng pháº£i Ä‘á»‡ quy Ä‘Ã¢u nÃªn khÃ´ng bá»‹ stack overflow). Code cá»¥ thá»ƒ nhÆ° sau:

                    <pre><code class="language-javascript">let lastTime = performance.now();
let dt = 0; // delta time

function update(time = performance.now()) {
    dt = (time - lastTime) / 1000;  //dt tÃ­nh theo giÃ¢y cho dá»… hÃ¬nh dung
    lastTime = time;

    // lÃ m gÃ¬ Ä‘Ã³ má»—i frame (nhá»› sá»­ dá»¥ng dt)

    requestAnimationFrame(update);
}

update();   //gá»i hÃ m Ä‘á»ƒ báº¯t Ä‘áº§u loop</code></pre>
                    
                    á» giá»¯a hÃ m update Ä‘Ã³ ta sáº½ Ä‘á»ƒ Ä‘oáº¡n code thay Ä‘á»•i cÃ¡c thuá»™c tÃ­nh cá»§a 2 cube (xoay 2 cube theo dt),
                    táº­p há»£p cÃ¡c tam giÃ¡c xong project vÃ  váº½ chÃºng. NhÆ°ng trÆ°á»›c khi váº½, ta cáº§n pháº£i clear mÃ n
                    hÃ¬nh Ä‘á»ƒ trÃ¡nh váº½ chá»“ng láº·p lÃªn nhau:
                    <pre><code class="language-javascript">let lastTime = performance.now();
let dt = 0;

function update(time = performance.now()) {
    dt = (time - lastTime) / 1000;
    lastTime = time;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    cube1.rotateY(50 * dt);
    cube2.rotateX(50 * dt);

    let allTris = [];
    allTris.push(...cube1.getTransformedTriangles());
    allTris.push(...cube2.getTransformedTriangles());
    for (let tri of allTris) {
        ...
    }

    requestAnimationFrame(update);
}

update();</code></pre>
                    Káº¿t quáº£:
                    <div class="htmlPreview" id="htmlPreview10"></div>

                    Sáº½ hay hÆ¡n náº¿u ta tÃ­nh luÃ´n fps nhá»‰ ğŸ˜³ cÅ©ng khÃ¡ Ä‘Æ¡n giáº£n, chá»‰ cáº§n vá»«a Ä‘áº¿m sá»‘ frame Ä‘Ã£ qua vá»«a Ä‘áº¿m thá»i gian (báº±ng dt), náº¿u Ä‘á»§ 1s thÃ¬ cáº­p nháº­t sá»‘ frame
                    trong 1s vá»«a rá»“i lÃªn mÃ n hÃ¬nh, xong reset láº¡i sá»‘ frame Ä‘Ã£ Ä‘áº¿m lÃ  oke:
                    <pre><code class="language-html">&lt;h2 id="fps"&gt;FPS: 0&lt;/h2&gt;</code></pre>
                    <pre><code class="language-javascript">const fpsInfo = document.getElementById("fps");
let fps = 0, frames = 0, fpsTimeCounter = 0;
    
function update(time = performance.now()) {
    dt = (time - lastTime) / 1000;
    lastTime = time;

    fpsTimeCounter += dt;
    frames++;
    if (fpsTimeCounter >= 1) {
        fpsInfo.textContent = `FPS: ${frames}`;
        frames = 0;
        fpsTimeCounter = 0;
    }

    ...
}</code></pre>
                    Káº¿t quáº£:
                    <div class="htmlPreview" id="htmlPreview11"></div>

                    Báº¡n nhÃ¬n nÃ³ xoay lÃ¢u lÃ¢u sáº½ tháº¥y illusion lÃ  máº·t Ä‘áº±ng sau lÃ  máº·t Ä‘áº±ng trÆ°á»›c, sáº½ tháº¥y nÃ³ bá»‹ mÃ©o mÃ³. VÃ¬ váº­y tiáº¿p theo mÃ¬nh sáº½ nÃ³i cho báº¡n vá» face culling,
                    lÃ  má»™t ká»¹ thuáº­t giáº¥u Ä‘i nhá»¯ng tam giÃ¡c Ä‘ang khÃ´ng hÆ°á»›ng vá» phÃ­a camera, nÃ³i cÃ¡ch khÃ¡c lÃ  nhá»¯ng tam giÃ¡c cÃ³ máº·t "Ä‘áº±ng sau" quay vá» phÃ­a mÃ¬nh. Cháº¯c báº¡n cÅ©ng
                    tá»«ng tháº¥y hiá»‡n tÆ°á»£ng nÃ y trong game, khi báº¡n noclip vÃ o trong 1 váº­t nÃ o Ä‘Ã³, báº¡n váº«n tháº¥y Ä‘Æ°á»£c tháº¿ giá»›i bÃªn ngoÃ i, vÃ¬ máº·c Ä‘á»‹nh máº·t "Ä‘áº±ng sau" cá»§a cÃ¡c tam
                    giÃ¡c sáº½ khÃ´ng Ä‘Æ°á»£c hiá»ƒn thá»‹.<br/><br/>
                    Face culling khÃ¡ dá»…, trÆ°á»›c tiÃªn, Ä‘á»‘i vá»›i tá»«ng tam giÃ¡c, báº¡n pháº£i tÃ¬m Ä‘Æ°á»£c vector phÃ¡p tuyáº¿n \(\vec{n}\) cá»§a nÃ³, sau Ä‘Ã³ so sÃ¡nh vá»›i vector tá»« camera hÆ°á»›ng lÃªn tÃ¢m cá»§a tam giÃ¡c Ä‘Ã³ \(a\),
                    náº¿u gÃ³c há»£p giá»¯a \(\vec{n}\) vÃ  \(a\) nhá» hÆ¡n 90, thÃ¬ tá»©c lÃ  tam giÃ¡c Ä‘Ã³ Ä‘ang nhÃ¬n "theo hÆ°á»›ng" camera, lÃ  mÃ¬nh sáº½ tháº¥y Ä‘Æ°á»£c "Ä‘áº±ng sau" cá»§a nÃ³, ngÆ°á»£c láº¡i
                    náº¿u gÃ³c Ä‘Ã³ lá»›n hÆ¡n 90, lÃ  tam giÃ¡c Ä‘ang quay "vá» phÃ­a" camera.<br/>
                    Äáº§u tiÃªn Ä‘á»ƒ tÃ¬m Ä‘Æ°á»£c \(\vec{n}\) cá»§a má»™t tam giÃ¡c, ta sáº½ sá»­ dá»¥ng má»™t khÃ¡i niá»‡m mÃ  ta Ä‘Ã£ tá»«ng há»c á»Ÿ cáº¥p 3, Ä‘Ã³ chÃ­nh lÃ  tÃ­ch cÃ³ hÆ°á»›ng. Náº¿u báº¡n khÃ´ng nhá»› thÃ¬ tÃ­ch cÃ³ hÆ°á»›ng
                    cá»§a 2 vector sáº½ ra káº¿t quáº£ lÃ  má»™t vector thá»© 3 vuÃ´ng gÃ³c vá»›i cáº£ 2 vector Ä‘Ã³, vÃ  Ä‘Æ°á»£c tÃ­nh nhÆ° sau:
                    $$
\vec{a} \times \vec{b} = 
\begin{pmatrix}
a_x\\
a_y\\
a_z
\end{pmatrix}
\times
\begin{pmatrix}
b_x\\
b_y\\
b_z
\end{pmatrix}
=
\begin{pmatrix}
a_y b_z - a_z b_y \\
a_z b_x - a_x b_z \\
a_x b_y - a_y b_x
\end{pmatrix}
                    $$
                    Äá»‘i vá»›i má»™t tam giÃ¡c, ta chá»‰ cáº§n láº¥y tÃ­ch cÃ³ hÆ°á»›ng cá»§a 2 cáº¡nh báº¥t ká»³ lÃ  sáº½ ra vector phÃ¡p tuyáº¿n cá»§a tam giÃ¡c Ä‘Ã³. Tuy nhiÃªn báº¡n nÃªn biáº¿t lÃ  khi báº¡n Ä‘áº£o chiá»u má»™t
                    trong 2 vector, nÃ³ váº«n sáº½ ra má»™t vector vuÃ´ng gÃ³c vá»›i 2 vector ban Ä‘áº§u, nhÆ°ng sáº½ bá»‹ ngÆ°á»£c chiá»u. ÄÃ³ lÃ  lÃ­ do á»Ÿ <a href="graphics3D2-definitions.html">blog 2</a>
                    mÃ¬nh nÃ³i lÃ  thá»© tá»± cÃ¡c Ä‘á»‰nh cá»§a tam giÃ¡c pháº£i thá»‘ng nháº¥t cÃ¹ng chiá»u hay ngÆ°á»£c chiá»u kim Ä‘á»“ng há»“, Ä‘á»ƒ tam giÃ¡c nÃ o cÅ©ng thá»‘ng nháº¥t má»™t kiá»ƒu
                    vector phÃ¡p tuyáº¿n.<br/><br/>
                    BÃ¢y giá» váº¥n Ä‘á» tiáº¿p theo ta cáº§n giáº£i quyáº¿t lÃ  xÃ¡c Ä‘á»‹nh xem vector phÃ¡p tuyáº¿n cá»§a tam giÃ¡c cÃ³ "hÆ°á»›ng vá»" camera hay khÃ´ng, Ä‘á»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u nÃ y ta cÅ©ng sá»­ dá»¥ng má»™t 
                    khÃ¡i niá»‡m mÃ  ta há»c há»“i cáº¥p 2, Ä‘Ã³ chÃ­nh lÃ  tÃ­ch vÃ´ hÆ°á»›ng. ÄÆ°á»£c tÃ­nh báº±ng cÃ¡ch sau:
                    $$
                        \vec{a} \cdot \vec{b}= a_x b_x + a_y b_y + a_z b_z
                    $$
                    NgoÃ i ra tÃ­ch vÃ´ hÆ°á»›ng cÅ©ng cÃ³ cÃ´ng thá»©c sau, \(\theta\) lÃ  gÃ³c há»£p giá»¯a \(\vec{a}\) vÃ  \(\vec{b}\):
                    $$
                        \vec{a} \cdot \vec{b}= |a||b|cos\theta
                    $$
                    VÃ¬ trong cÃ´ng thá»©c trÃªn cÃ³ \(cos\theta\), nÃªn \(\vec{a} \cdot \vec{b} > 0\) khi \(\theta < 90\), \(\vec{a} \cdot \vec{b} < 0\) khi  \(\theta > 90\). ÄÃºng cÃ¡i ta cáº§n,
                    \(\theta < 90\) nghÄ©a lÃ  \(\vec{a}\) vÃ  \(\vec{b}\) Ä‘ang "hÆ°á»›ng cÃ¹ng nhau" vÃ  \(\theta > 90\) nghÄ©a lÃ  \(\vec{a}\) vÃ  \(\vec{b}\) Ä‘ang "hÆ°á»›ng ngÆ°á»£c nhau".<br/><br/>

                    HÃ m tÃ­nh tÃ­ch vÃ´ hÆ°á»›ng (dot) vÃ  tÃ­ch cÃ³ hÆ°á»›ng (cross) ta Ä‘Ã£ lÃ m sáºµn á»Ÿ class Vector3. ÄÃ³i vá»›i class Triangle ta sáº½ thÃªm hÃ m tÃ¬m tÃ¢m getCenter vÃ  hÃ m tÃ¬m vector phÃ¡p tuyáº¿n
                    getNormal:
                    <pre><code class="language-javascript">getCenter() {
    let x = (this.vertices[0].x + this.vertices[1].x + this.vertices[2].x) / 3.0;
    let y = (this.vertices[0].y + this.vertices[1].y + this.vertices[2].y) / 3.0;
    let z = (this.vertices[0].z + this.vertices[1].z + this.vertices[2].z) / 3.0;
    return new Vector3(x, y, z);
}

getNormal() {
    let v1 = Vector3.sub(this.vertices[0], this.vertices[1]);
    let v2 = Vector3.sub(this.vertices[1], this.vertices[2]);
    let normal = Vector3.cross(v1, v2);
    normal.normalize();
    return normal;
}</code></pre>
                    
                    á» Ä‘oáº¡n code váº½ chÃ­nh, trÆ°á»›c khi xá»­ lÃ½ 1 tam giÃ¡c, ta cáº§n xÃ©t Ä‘iá»u kiá»‡n tÃ­ch vÃ´ hÆ°á»›ng trÆ°á»›c:
                    <pre><code class="language-javascript">let cameraPos = new Vector3(0, 0, 0);
...
                        
for (let tri of allTris) {
    if (Vector3.dot(tri.getNormal(), Vector3.sub(tri.getCenter(), cameraPos)) < 0) {
        ...    
    }
}</code></pre>
                    Káº¿t quáº£ nhÆ° sau:
                    <div class="htmlPreview" id="htmlPreview12"></div>

                    Báº¡n cÅ©ng tháº¥y lÃ  ngoÃ i giÃºp hiá»ƒn thá»‹ Ä‘á»“ váº­t há»£p lÃ½ ra thÃ¬ face culling cÅ©ng lÃ m giáº£m sá»‘ tam giÃ¡c pháº£i váº½, giÃºp cáº£i thiá»‡n performance khÃ¡ nhiá»u.

                    <div id="graphics3D-nav-bottom"></div>
                </div>

            </div>
        </div>
    </main>

    <footer></footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

    <script src="graphics3D.js"></script>
    <script src="/js/loadsidebar.js"></script>
</body>

</html>