<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@200&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/blogcontent.css">
    <link rel="stylesheet" href="/css/prism.css">
    <link rel="stylesheet" href="graphics3D.css">

    <script src="/js/prism.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <title>Graphics Engine 3D</title>
</head>

<body data-graphics3D-id="graphics3D6">
    <main>
        <div class="container-fluid ps-0">
            <div class="row">
                <div class="col-12 col-lg-2 sidebar pb-0 pe-0">
                    <!--load from sidebar.html-->
                </div>

                <div class="blog-content col-12 col-lg-10">
                    <div id="graphics3D-nav-top"></div>
                    <h1>Game loop</h1>
                    
                    Tá»« blog Ä‘áº§u tiÃªn tá»›i giá» ta chá»‰ cÃ³ táº¡o vÃ  hiá»ƒn thá»‹ object lÃªn mÃ n hÃ¬nh, nhÆ°ng chÃºng khÃ´ng há» di chuyá»ƒn, khÃ¡ chÃ¡n.
                    Cho nÃªn blog nÃ y ta sáº½ cÃ i Ä‘áº·t má»™t há»‡ thá»‘ng Game loop, nÃ³i nÃ´m na lÃ  cáº­p nháº­t frame theo thá»i gian má»™t cÃ¡ch á»•n Ä‘á»‹nh. Blog nÃ y sáº½ khÃ¡ ngáº¯n vÃ  dá»…
                    hiá»ƒu, lÃ  má»™t breath of fresh air sau vÃ i blog náº·ng vá» toÃ¡n vá»«a rá»“i ğŸ¥µ<br/><br/>

                    Äáº§u tiÃªn báº¡n nÃªn biáº¿t lÃ  khÃ´ng cÃ³ mÃ¡y tÃ­nh nÃ o cÃ³ tá»‘c Ä‘á»™ xá»­ lÃ½ giá»‘ng nhau, náº¿u báº¡n lÃ m game mÃ  khÃ´ng Ä‘á»ƒ Ã½ tá»›i fact Ä‘Ã³, thÃ¬ nÃ³ sáº½ bá»‹ hiá»‡n tÆ°á»£ng
                    slow motion trÃªn mÃ¡y cháº­m, vÃ  cháº¡y nhÆ° flash trÃªn mÃ¡y nhanh, Ä‘iá»ƒn hÃ¬nh lÃ  Dark souls remastered bá»‹ váº¥n Ä‘á» nÃ y (báº£n cÅ© thÃ¬ khÃ´ng bá»‹). VÃ­ dá»¥ Ä‘Æ¡n giáº£n vá»›i
                    vá»‹ trÃ­ cá»§a object, lÃ½ do xáº£y ra váº¥n Ä‘á» trÃªn lÃ  má»i frame báº¡n Ä‘á»u cá»™ng 1 khoáº£ng giá»‘ng nhau, mÃ¡y nhanh xá»­ lÃ½ xong 1 frame trong 0.03s báº¡n cá»™ng 2m, mÃ¡y cháº­m
                    xá»­ lÃ½ xong 1 frame trong 0.07s báº¡n cÅ©ng cá»™ng 2m, thÃ¬ táº¥t nhiÃªn lÃ  nÃ³ sáº½ bá»‹ cháº¡y cháº­m hÆ¡n trÃªn mÃ¡y cháº­m vÃ  nhanh hÆ¡n trÃªn mÃ¡y nhanh. Náº¿u ngÃ y xÆ°a báº¡n tá»«ng 
                    lÃ m game console báº±ng C++, báº¡n sáº½ gáº·p qua váº¥n Ä‘á» nÃ y khi cá»© cá»™ng khoáº£ng y há»‡t má»—i vÃ²ng láº·p while loop ğŸ˜….<br/><br/>
                    
                    CÃ¡ch giáº£i quyáº¿t váº¥n
                    Ä‘á» nÃ y khÃ¡ dá»…, báº¡n chá»‰ cáº§n Ä‘áº·t clock Ä‘áº¿m xem frame trÆ°á»›c xá»­ lÃ½ xong trong bao lÃ¢u (khoáº£ng thá»i gian nÃ y Ä‘Æ°á»£c gá»i lÃ  delta time (\(\Delta t\))),
                    rá»“i sau Ä‘Ã³ cá»™ng khoáº£ng phÃ¹ há»£p vá»›i \(\Delta t\): frame trÆ°á»›c xong trong 0.03s thÃ¬ cá»™ng 2 * 0.03 m, frame trÆ°á»›c xong trong 0.07s thÃ¬ cá»™ng 2 * 0.07m 
                    (máº¥t thá»i gian lÃ¢u hÆ¡n Ä‘á»ƒ xá»­ lÃ½ thÃ¬ cho di chuyá»ƒn xa hÆ¡n Ä‘á»ƒ bÃ¹ láº¡i khoáº£ng thá»i gian Ä‘Ã³). 
                    NhÆ° váº­y sáº½ giáº£i quyáº¿t Ä‘Æ°á»£c váº¥n Ä‘á» slow motion, nhÆ°ng bÃ¢y giá» vá»‹ trÃ­ váº­t trÃªn mÃ¡y cháº­m sáº½ bá»‹ giáº­t giáº­t, nhÆ°ng mÃ  váº«n Ä‘áº£m báº£o váº­t sáº½ luÃ´n á»Ÿ chung vá»‹ trÃ­ vá»›i 
                    mÃ¡y nhanh.<br/><br/>

                    Äá»ƒ Ä‘áº¿m thá»i gian trong javascript khÃ¡ dá»…, ta chá»‰ cáº§n xÃ i <a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance/now">performance.now()</a>,
                    lÃ  hÃ m Ä‘áº¿m sá»‘ mili giÃ¢y tá»« ká»ƒ tá»« <a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance/timeOrigin">Performance.timeOrigin</a>.
                    Äá»‘i vá»›i loop frame thÃ¬ sá»­ dá»¥ng hÃ m 
                    <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/requestAnimationFrame">requestAnimationFrame()</a>, lÃ  hÃ m yÃªu cáº§u browser gá»i má»™t hÃ m
                    callback trÆ°á»›c láº§n váº½ káº¿ tiáº¿p, hÃ m callback Ä‘Ã³ pháº£i cÃ³ tham sá»‘ Ä‘áº§u tiÃªn lÃ  má»™t biáº¿n Ä‘áº¡i diá»‡n cho sá»‘ mili giÃ¢y ká»ƒ tá»« <a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance/timeOrigin">timeOrigin</a>,
                    chÃ­nh lÃ  thá»© mÃ  ta vá»«a nÃ³i tá»›i. Ta sáº½ táº¡o má»™t hÃ m update, vÃ  á»Ÿ cuá»‘i hÃ m ta dÃ¹ng requestAnimationFrame Ä‘á»ƒ gá»i callback lÃ  chÃ­nh nÃ³ 
                    (Ä‘á»«ng lo, nÃ³ khÃ´ng pháº£i Ä‘á»‡ quy Ä‘Ã¢u nÃªn khÃ´ng bá»‹ stack overflow). Code cá»¥ thá»ƒ nhÆ° sau:

                    <pre><code class="language-javascript">let lastTime = performance.now();
let dt = 0; // delta time

function update(time = performance.now()) {
    dt = (time - lastTime) / 1000;  //dt tÃ­nh theo giÃ¢y cho dá»… hÃ¬nh dung
    lastTime = time;

    // lÃ m gÃ¬ Ä‘Ã³ má»—i frame (nhá»› sá»­ dá»¥ng dt)

    requestAnimationFrame(update);
}

update();   //gá»i hÃ m Ä‘á»ƒ báº¯t Ä‘áº§u loop</code></pre>
                    
                    á» giá»¯a hÃ m update Ä‘Ã³ ta sáº½ Ä‘á»ƒ Ä‘oáº¡n code thay Ä‘á»•i cÃ¡c thuá»™c tÃ­nh cá»§a 2 cube (xoay 2 cube theo dt),
                    táº­p há»£p cÃ¡c tam giÃ¡c xong project vÃ  váº½ chÃºng. NhÆ°ng trÆ°á»›c khi váº½, ta cáº§n pháº£i clear mÃ n
                    hÃ¬nh Ä‘á»ƒ trÃ¡nh váº½ chá»“ng láº·p lÃªn nhau:
                    <pre><code class="language-javascript">let lastTime = performance.now();
let dt = 0;

function update(time = performance.now()) {
    dt = (time - lastTime) / 1000;
    lastTime = time;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    cube1.rotation = new Vector3(cube1.rotation.x, cube1.rotation.y + 50 * dt, cube1.rotation.z);
    cube2.rotation = new Vector3(cube2.rotation.x + 50 * dt, cube2.rotation.y, cube2.rotation.z + 50 * dt);

    let allTris = [];
    allTris.push(...cube1.getTransformTriangles());
    allTris.push(...cube2.getTransformTriangles());
    for (let tri of allTris) {
        ...
    }

    requestAnimationFrame(update);
}

update();</code></pre>
                    Káº¿t quáº£:
                    <div class="htmlPreview" id="htmlPreview10"></div>
                    <div id="graphics3D-nav-bottom"></div>
                </div>

            </div>
        </div>
    </main>

    <footer></footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

    <script src="graphics3D.js"></script>
    <script src="/js/loadsidebar.js"></script>
</body>

</html>