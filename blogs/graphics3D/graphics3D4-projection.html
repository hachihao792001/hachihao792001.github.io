<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@200&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/blogcontent.css">
    <link rel="stylesheet" href="/css/prism.css">
    <link rel="stylesheet" href="graphics3D.css">

    <script src="/js/prism.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <title>Graphics Engine 3D</title>
</head>

<body data-graphics3D-id="graphics3D4">
    <main>
        <div class="container-fluid ps-0">
            <div class="row">
                <div class="col-12 col-lg-2 sidebar pb-0 pe-0">
                    <!--load from sidebar.html-->
                </div>

                <div class="blog-content col-12 col-lg-10">
                    <div id="graphics3D-nav-top"></div>
                    <h1>Projection matrix</h1>
                    Trong blog tr∆∞·ªõc, ta ƒë√£ v·∫Ω ƒë∆∞·ª£c m·ªôt cube l√™n canvas r·ªìi. Tuy nhi√™n ta c√≤n nh·ªØng
                    v·∫•n ƒë·ªÅ sau ƒë√¢y c·∫ßn gi·∫£i quy·∫øt:
                    <ol>
                        <li>L√†m g√¨ n·∫øu m√¨nh mu·ªën ch·ªânh t·∫ßm nh√¨n (FOV) c·ªßa m√¨nh?</li>
                        <li>Chuy·ªán g√¨ x·∫£y ra khi cube qu√° g·∫ßn m√†n h√¨nh?</li>
                    </ol>

                    Ch·∫Øc b·∫°n c≈©ng ƒë√£ bi·∫øt FOV (Field of view) l√† t·∫ßm nh√¨n c·ªßa m·∫Øt ng∆∞·ªùi hay camera trong game, fov c√†ng l·ªõn, c√†ng nh√¨n ƒë∆∞·ª£c r·ªông.
                    C·ª• th·ªÉ h∆°n, trong game c≈©ng nh∆∞ ngo√†i ƒë·ªùi, m·∫Øt m√¨nh nh√¨n th·∫ø gi·ªõi theo h√¨nh ch√≥p c·ª•t (frustum), 2
                    h√¨nh sau ƒë·∫°i di·ªán cho t·∫ßm nh√¨n c·ªßa m√¨nh khi nh√¨n t·ª´ tr√™n xu·ªëng v√† nh√¨n t·ª´ ngang qua:
                    <div align="center">
                        <img src="images/graphics3D2/fov1.png" style="max-width: 400px;" />
                        <img src="images/graphics3D2/fov2.png" style="max-width: 400px;" />
                    </div>
                    M√¨nh ƒë·ªÉ -1 v√† +1 ·ªü ch·ªó m√†n h√¨nh v√† ch·ªó ƒë√°y frustum kia ƒë·ªÉ b·∫°n nh·ªõ r·∫±ng kho·∫£ng m√¨nh nh√¨n ƒë∆∞·ª£c ƒëang scale t·ª´ t·ª´ l√™n t·ª´
                    m√†n h√¨nh ƒë·∫øn ƒë√°y frustum, v√† c≈©ng ƒë·ªÉ b·∫°n nh·ªõ v·ªÉ gi√° tr·ªã chu·∫©n c·ªßa m√†n h√¨nh.<br/><br/>
                    ƒê·∫∑t FOV l√† theta (\(Œ∏\)) (h√¨nh 2), chia tam gi√°c t·∫ßm nh√¨n th√†nh 2 tam gi√°c vu√¥ng, th·∫•y r·∫±ng 
                    FOV c√†ng l·ªõn th√¨ c·∫°nh ƒë·ªëi (\(opposite\)) c√†ng l·ªõn, v√† t·ªça ƒë·ªô m√†n h√¨nh (\(P\)) c·ªßa
                    c√°c v·∫≠t c√†ng g·∫ßn t√¢m m√†n h√¨nh h∆°n, m√† nh∆∞ ta bi·∫øt th√¨ t√¢m m√†n h√¨nh ch√≠nh l√† (0, 0), t·ª©c l√†
                    t·ªça ƒë·ªô m√†n h√¨nh c·ªßa v·∫≠t s·∫Ω c√†ng nh·ªè khi FOV c√†ng l·ªõn, suy ra t·ªça ƒë·ªô v·∫≠t s·∫Ω t·ªâ l·ªá ngh·ªãch v·ªõi FOV v√† t·ªâ l·ªá ngh·ªãch
                    v·ªõi c·∫°nh ƒë·ªëi: \(P \backsim \frac{1}{opposite}\). ƒê·ªëi v·ªõi c·∫°nh k·ªÅ (\(adjacent\)) c·ªßa 2 h√¨nh tr√™n, ƒë√≥ ch√≠nh l√† kho·∫£ng c√°ch t·ª´ m·∫Øt ƒë·∫øn kho·∫£ng
                    xa nh·∫•t m√† ta c√≥ th·ªÉ nh√¨n th·∫•y ƒë∆∞·ª£c, c√≥ th·ªÉ l√† b·∫•t k·ª≥ h·∫±ng s·ªë n√†o, v√¨ l√† h·∫±ng s·ªë n√™n ta c≈©ng c√≥ th·ªÉ suy ra r·∫±ng: \(P \backsim \frac{adjacent}{opposite}\).
                    V√† nh∆∞ ta bi·∫øt, \(tan\) b·∫±ng ƒë·ªëi chia k·ªÅ, t·ª©c l√†: \(P \backsim \frac{1}{tan(\frac{Œ∏}{2})}\).<br />
                    N·∫øu b·∫°n ƒë·ªÉ √Ω, \(Œ∏\) l√† g√≥c ·ªü h√¨nh th·ª© 2 ch·ª© kh√¥ng ph·∫£i h√¨nh th·ª© 1, v√¨ ta ƒëang s·ª≠ d·ª•ng vertical FOV, v√† h·∫ßu h·∫øt game n√†o c≈©ng
                    s·ª≠ d·ª•ng vertical FOV, l√≠ do gi·ªëng v·ªõi vi·ªác ta nh√¢n aspect ratio ·ªü x thay v√¨ ·ªü y, ƒëi·ªÅu n√†y kh√¥ng h·ªÅ ƒë∆∞·ª£c nh·∫Øc t·ªõi trong video c·ªßa javidx9 btw.<br/><br/>

                    V√¨ \(P \backsim \frac{1}{tan(\frac{Œ∏}{2})}\), ta s·∫Ω nh√¢n x, y v·ªõi \(\frac{1}{tan(\frac{Œ∏}{2})}\):
                    <pre><code class="language-javascript">const fov = 90;
let fovMultiplier = 1.0 / Math.tan(fov * 0.5 / 180.0 * Math.PI);    //h√†m Math.tan nh·∫≠n radian, ph·∫£i chuy·ªÉn ƒë·ªô th√†nh radian
...
vertices[i] = new Vector3(
    v.x * fovMultiplier * canvas.height + canvas.width / 2,
    -v.y * fovMultiplier * canvas.height + canvas.height / 2,
    1);</code></pre>
                    Hi·ªÉn th·ªã nh∆∞ sau (b·∫°n t·ª± copy v·ªÅ thay ƒë·ªïi FOV ƒë·ªÉ xem kh√°c bi·ªát nh√©):
                    <div id="htmlPreview7" class="htmlPreview"></div><br/>

                    V·ªÅ v·∫•n ƒë·ªÅ th·ª© hai, khi cube qu√° g·∫ßn m√†n h√¨nh, th√¨ nh·ªØng tam gi√°c c·ªßa n√≥ s·∫Ω ƒë∆∞·ª£c v·∫Ω r·∫•t l√† to,
                    v∆∞·ª£t c·∫£ ra ngo√†i m√†n h√¨nh, g√¢y lag m√°y (n·∫øu nh∆∞ m√¨nh ƒëang c·ªë t√¥ m√†u cube, s·∫Ω l√†m sau).
                    ƒê·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ tr√™n, ta s·∫Ω ƒë·∫∑t gi√° tr·ªã z nh·ªè nh·∫•t m√† v·∫´n ƒë∆∞·ª£c v·∫Ω l√† \(z_{near}\), g·ªçi m·∫∑t ph·∫≥ng t·∫≠p h·ª£p nh·ªØng ƒëi·ªÉm c√≥ gi√° tr·ªã
                    z nh·ªè nh·∫•t ƒë√≥ l√† near plane (m·∫∑t ph·∫≥ng n√†y vu√¥ng g√≥c v·ªõi h∆∞·ªõng nh√¨n camera), ƒë·ªìng nghƒ©a nh·ªØng g√¨ n·∫±m gi·ªØa camera v√† m·∫∑t ph·∫≥ng ƒë√≥ s·∫Ω kh√¥ng ƒë∆∞·ª£c v·∫Ω
                    , ngo√†i ra ta ƒë·∫∑t th√™m m·ªôt far plane (\(z_{far}\)) ·ªü ƒë·∫±ng xa ƒë·ªÉ kh√¥ng v·∫Ω lu√¥n nh·ªØng v·∫≠t ·ªü qu√° xa (nh·ªè) ƒë·ªÉ th·∫•y.<br/>
                    Theo l√Ω thuy·∫øt, nh·ªØng th·ª© ƒë·∫±ng sau camera (c√≥ z √¢m) s·∫Ω kh√¥ng th·∫•y ƒë∆∞·ª£c, b√¢y gi·ªù, n√≥ ph·∫£i l√† "nh·ªØng th·ª© ƒë·∫±ng sau near plane
                    s·∫Ω kh√¥ng th·∫•y ƒë∆∞·ª£c". Tuy nhi√™n, ta kh√¥ng n√™n if \(z < z_{near}\) th√¨ kh√¥ng hi·ªÉn th·ªã, ki·ªÉu ch·∫•p v√° n√†y s·∫Ω kh√≥ t√≠nh to√°n v·ªÅ sau, m√†
                    ta n√™n ƒë·ªãnh nghƒ©a m·ªôt \(z'\) m·ªõi theo ki·ªÉu n√≥ s·∫Ω b·∫±ng 0 khi ·ªü near plane, nh∆∞ng far plane v·∫´n gi·ªØ nguy√™n.
                    <div align="center">
                        <img style="display:block; max-width: 300px;" src="images/graphics3D3/znearzfar.png"/>
                    </div>
                    Trong h√¨nh b·∫°n ƒëang th·∫•y frustum m·ªõi \([z_{near}; z_{far}]\) m√† ta mu·ªën hi·ªÉn th·ªã, ta ph·∫£i gi√£n v√† l√πi frustum m·ªõi n√†y 
                    ƒë·ªÉ hi·ªÉn th·ªã cho ƒë√∫ng rule "z √¢m th√¨ kh√¥ng hi·ªÉn th·ªã, far plane gi·ªØ nguy√™n".
                    Tr∆∞·ªõc ti√™n ta s·∫Ω l·∫•y \(z - z_{near}\) ƒë·ªÉ l√πi frustum v·ªÅ 0, sau ƒë√≥ chia \((z_{far} - z_{near})\) v√†
                    nh√¢n \(z_{far}\) ƒë·ªÉ n√≥ gi√£n ra nh∆∞ tr√™n ƒë√£ n√≥i, b√¢y gi·ªù c√¥ng th·ª©c th√†nh:
                    $$
                        z' = (z-z_{near})*\frac{z_{far}}{z_{far}-z_{near}} = z\frac{z_{far}}{z_{far}-z_{near}} - z_{near}\frac{z_{far}}{z_{far}-z_{near}}
                    $$
                    C√°i ng∆∞·ªùi ta th∆∞·ªùng l√†m l√† l·∫•y t·∫•t c·∫£ chia cho z ban ƒë·∫ßu. V√¨ sao? ƒê√≥ l√† do ta mu·ªën n√≥ c√≥ t√≠nh ch·∫•t "c√†ng g·∫ßn 0 c√†ng thay ƒë·ªïi nhi·ªÅu",
                    ƒë√≥ l√† v√¨ \(z'\) l√† m·ªôt h√†m theo bi·∫øn \(z\) c√≥ d·∫°ng l√†
                    \(f(z) = a + bz\) v·ªõi \(a = - z_{near}\frac{z_{far}}{z_{far}-z_{near}}\) v√† \(b = \frac{z_{far}}{z_{far}-z_{near}}\),
                    chia cho \(z\) s·∫Ω bi·∫øn n√≥ th√†nh d·∫°ng \(f(z) = a + b\frac{1}{z}\), l√† m·ªôt h√†m 
                    <a href="https://vi.wikipedia.org/wiki/H√†m_hyperbol">Hyperbol</a>. B·∫°n c√≥ th·ªÉ xem r√µ h∆°n khi t√≠nh n√≥ ·ªü excel ho·∫∑c v·∫Ω ƒë·ªì th·ªã ra,
                    d∆∞·ªõi ƒë√¢y l√† 2 h√¨nh so s√°nh 3 gi√° tr·ªã: \((z-z_{near})*\frac{z_{far}}{z_{far}-z_{near}}\), sau khi nh√¢n \(z_{far}\) v√† sau khi chia \(z\):
                    <div align="center" style="gap: 10px;">
                        <img style="max-height: 300px; border: 1px solid black;" src="images/graphics3D3/normalizedZ excel.png"/>
                        <img style="max-height: 300px; margin-left: 40px; border: 1px solid black;" src="images/graphics3D3/normalizedZ desmos.png"/>
                    </div>
                    B·∫°n s·∫Ω th·∫•y sau khi chia z, n√≥ v·ªÅ l·∫°i kho·∫£ng [0; 1], nh∆∞ng thay v√¨ tƒÉng l√™n ƒë·ªÅu, n√≥ l·∫°i c√†ng tƒÉng c√†ng ch·∫≠m, ƒë∆∞·ª£c th·ªÉ hi·ªán kh√° r√µ ·ªü ƒë·ªì th·ªã c·ªßa n√≥ (ƒë∆∞·ªùng hyperbol m√†u ƒë·ªè).
                    Vi·ªác ƒë∆∞a n√≥ v·ªÅ l·∫°i [0; 1] th·∫ø n√†y gi√∫p cho z ƒë∆∞·ª£c chu·∫©n h√≥a (normalized), d·ªÖ t√≠nh to√°n v·ªÅ sau.
                    <br/><br/>
                    T√≠nh ch·∫•t "c√†ng g·∫ßn 0 c√†ng thay ƒë·ªïi nhi·ªÅu" s·∫Ω gi√∫p cho nh·ªØng v·∫≠t g·∫ßn camera s·∫Ω hi·ªÉn th·ªã ch√≠nh x√°c v√† t√°ch bi·ªát r√µ r√†ng h∆°n khi z c·ªßa ch√∫ng g·∫ßn nhau
                    (<a href="https://en.wikipedia.org/wiki/Z-fighting">z-fighting</a>). M·ªôt l√≠ do kh√°c ƒë·ªÉ chia z l√† v√¨ x, y tr∆∞·ªõc ƒë√≥ c≈©ng chia cho z, 
                    vi·ªác chia ph·∫ßn z cho z lu√¥n s·∫Ω gi√∫p ƒë∆°n gi·∫£n h√≥a v·∫•n ƒë·ªÅ (nh·∫•t l√† l√∫c d√πng ma tr·∫≠n).<br/><br/>
                    Tuy nhi√™n, b·∫°n ƒë·ªÉ √Ω l√† n√£y gi·ªù m√¨nh ch·ªâ thay ƒë·ªïi z ch·ª© kh√¥ng l√†m g√¨ li√™n quan t·ªõi x v√† y, cho n√™n khi th√™m code li√™n quan t·ªõi \(z_{far}\), \(z_{near}\) v√†o th√¨ c≈©ng
                    ch·∫£ thay ƒë·ªïi g√¨. ƒê√≥ l√† v√¨ \(z_{normalized}\) m√† m√¨nh v·ª´a t√≠nh ra d√πng cho c√°c b∆∞·ªõc t√≠nh li√™n quan t·ªõi ƒë·ªô s√¢u tr∆∞·ªõc khi th·ª±c hi·ªán c√°c ph√©p t√≠nh li√™n quan
                    t·ªõi m√†n h√¨nh, m√¨nh s·∫Ω n√≥i v·ªÅ n√≥ sau.<br/><br/>
                    
                    B√¢y gi·ªù, m√¨nh s·∫Ω l√πi l·∫°i m·ªôt t√≠ v√† quay v·ªÅ ti√™u ƒë·ªÅ c·ªßa blog n√†y, Projection Matrix l√† g√¨? Tr∆∞·ªõc h·∫øt, Projection ch√≠nh l√† m·ªôt ph√©p bi·∫øn ƒë·ªïi m√† ta l√†m t·ª´ blog tr∆∞·ªõc t·ªõi
                    gi·ªù, chuy·ªÉn c√°c t·ªça ƒë·ªô trong kh√¥ng gian 3D th√†nh t·ªça ƒë·ªô m√†n h√¨nh 2D. Nh∆∞ng tr∆∞·ªõc Projection th√¨ ta c√≥ ph√©p bi·∫øn ƒë·ªëi View, l√† chuy·ªÉn ƒë·ªïi th·∫ø gi·ªõi theo g√≥c nh√¨n v√† v·ªã tr√≠
                    c·ªßa camera (t·ª´ blog tr∆∞·ªõc t·ªõi gi·ªù ta lu√¥n m·∫∑c ƒë·ªãnh camera ·ªü (0, 0, 0)). V√† tr∆∞·ªõc View ta c√≥ c√≥ ph√©p bi·∫øn ƒë·ªïi Model, l√† thay ƒë·ªïi v·ªã tr√≠, ƒë·ªô xoay v√† k√≠ch th∆∞·ªõc c·ªßa c√°c
                    v·∫≠t trong kh√¥ng gian 3D. Ba ph√©p bi·∫øn ƒë·ªïi n√†y ƒë·ªÅu c√≥ th·ªÉ chuy·ªÉn th√†nh ma tr·∫≠n v√† nh√¢n (g·ªôp) nhau th√†nh m·ªôt ma tr·∫≠n duy nh·∫•t, g·ªçi l√† Model View Projection Matrix,
                    nh∆∞ v·∫≠y s·∫Ω gi·∫£m ph√©p t√≠nh ph·∫£i t√≠nh ƒë·ªëi v·ªõi m·ªçi ƒë·ªânh trong kh√¥ng gian 3D. V√† ngo√†i ra vi·ªác s·ª≠ d·ª•ng ma tr·∫≠n nh∆∞ v·∫≠y c≈©ng th√≠ch h·ª£p cho GPU, v√¨ GPU gi·ªèi t√≠nh
                    song song nhi·ªÅu ph√©p to√°n ƒë∆°n gi·∫£n c√πng l√∫c, cho n√™n ma tr·∫≠n hay ƒë∆∞·ª£c s·ª≠ d·ª•ng trong ƒë·ªì h·ªça m√°y t√≠nh. <br/><br/>

                    N·∫øu ng√†nh b·∫°n h·ªçc h·ªìi ƒê·∫°i h·ªçc kh√¥ng d·∫°y ƒê·∫°i s·ªë tuy·∫øn t√≠nh, hay b·∫°n ch∆∞a t·ª´ng h·ªçc ƒê·∫°i h·ªçc, th√¨ ch·∫Øc b·∫°n s·∫Ω kh√¥ng bi·∫øt ma tr·∫≠n l√† g√¨.
                    Ma tr·∫≠n ƒë∆°n gi·∫£n ch·ªâ l√† m·ªôt b·∫£ng c√°c s·ªë, nh∆∞ng c√°i m√¨nh c·∫ßn bi·∫øt duy nh·∫•t l√† ph√©p nh√¢n ma tr·∫≠n. V√≠ d·ª• ta c√≥ 2 ma tr·∫≠n \(A\) v√† \(B\):
                    $$
                        A =
                        \begin{pmatrix}
                        a_{11} & a_{12} & a_{13} \\
                        a_{21} & a_{22} & a_{23}
                        \end{pmatrix}; 
                        B =
                        \begin{pmatrix}
                        b_{11} & b_{12} \\
                        b_{21} & b_{22} \\
                        b_{31} & b_{32}
                        \end{pmatrix}
                    $$
                    Th√¨ ph√©p nh√¢n \(AB\) s·∫Ω ra m·ªôt ma tr·∫≠n m·ªõi:
                    $$
                        AB =
                        \begin{pmatrix}
                        a_{11}b_{11} + a_{12}b_{21} + a_{13}b_{31} &
                        a_{11}b_{12} + a_{12}b_{22} + a_{13}b_{32} \\

                        a_{21}b_{11} + a_{22}b_{21} + a_{23}b_{31} &
                        a_{21}b_{12} + a_{22}b_{22} + a_{23}b_{32}
                        \end{pmatrix}
                    $$
                    Ta l·∫•y t·ª´ng √¥ tr√™n t·ª´ng h√†ng c·ªßa \(A\) nh√¢n v√† c·ªông v·ªõi t·ª´ng √¥ tr√™n t·ª´ng c·ªôt c·ªßa \(B\). Ma tr·∫≠n k·∫øt qu·∫£ s·∫Ω c√≥ s·ªë h√†ng b·∫±ng s·ªë h√†ng c·ªßa \(A\) v√† s·ªë c·ªôt b·∫±ng s·ªë c·ªôt c·ªßa \(B\).
                    <div align="center">
                        <img style="max-width: 400px; display:block" src="https://miro.medium.com/1*YGcMQSr0ge_DGn96WnEkZw.png"/>
                        <i>Ngu·ªìn ·∫£nh: Medium</i>
                    </div>
                    Ngo√†i ra, m·ªôt ƒëi·ªÉm hay vector c≈©ng c√≥ th·ªÉ nh√¢n v·ªõi ma tr·∫≠n, k·∫øt qu·∫£ s·∫Ω ra m·ªôt vector kh√°c. Nh√¢n b·∫±ng c√°ch 
                    ƒë·ªÉ vector th√†nh m·ªôt ma tr·∫≠n c√≥ 1 c·ªôt v√† c√≥ s·ªë d√≤ng l√† s·ªë chi·ªÅu (3). Sau ƒë√≥, ta c·ª© nh√¢n theo rule b√¨nh th∆∞·ªùng (vector ƒë·ªÉ sau ma tr·∫≠n).
                    $$
                    \begin{pmatrix}
                    a_{11} & a_{12} & a_{13} \\
                    a_{21} & a_{22} & a_{23} \\
                    a_{31} & a_{32} & a_{33}
                    \end{pmatrix}
                    \begin{pmatrix}
                    x \\
                    y \\
                    z
                    \end{pmatrix}
                    =
                    \begin{pmatrix}
                    a_{11}x + a_{12}y + a_{13}z \\
                    a_{21}x + a_{22}y + a_{23}z \\
                    a_{31}x + a_{32}y + a_{33}z
                    \end{pmatrix} 
                    $$
                    Th·∫≠t ra b·∫°n c√≥ th·ªÉ ƒë·ªÉ vector th√†nh h√†ng ngang v√† ƒë·ªÉ b√™n tr√°i ma tr·∫≠n c≈©ng ƒë∆∞·ª£c, n√≥ s·∫Ω g·ªçi l√† row vector, c√°i m√† ta ƒëang x√†i l√† column vector. Hai c√°ch n√†y s·∫Ω ra
                    2 k·∫øt qu·∫£ kh√°c nhau, nh∆∞ng m√† c≈©ng kh√¥ng quan tr·ªçng, mi·ªÖn sao l√† b·∫°n x√†i m·ªôt th·ª© t·ª´ ƒë·∫ßu t·ªõi cu·ªëi, m√¨nh s·∫Ω x√†i column vector v√¨ n√≥ l√† ti√™u chu·∫©n c·ªßa ƒë·ªì h·ªça 3D.<br/><br/>

                    Quay tr·ªü l·∫°i v·ªõi Projection Matrix, t·ª´ blog tr∆∞·ªõc t·ªõi gi·ªù ta ƒë√£ th·ª±c hi·ªán c√°c th·ª© sau:
                    <ol>
                        <li>L·∫•y x nh√¢n chi·ªÅu cao chia chi·ªÅu r·ªông ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng v·ªõi aspect ratio</li>
                        <li>Chia x, y cho z ƒë·ªÉ t·∫°o c·∫£m gi√°c "c√†ng g·∫ßn c√†ng to"</li>
                        <li>Nh√¢n x, y v·ªõi \(\frac{1}{tan(\frac{Œ∏}{2})}\) ƒë·ªÉ d√πng FOV</li>
                        <li>Thay th·∫ø \(z\) b·∫±ng \(z_{normalized} = (z\frac{z_{far}}{z_{far}-z_{near}} - z_{near}\frac{z_{far}}{z_{far}-z_{near}})/z\) ƒë·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ g·∫ßn camera</li>
                    </ol>
                    L∆∞u √Ω l√† b∆∞·ªõc nh√¢n cho k√≠ch th∆∞·ªõc canvas kh√¥ng t√≠nh v√¨ ƒë√≥ l√† b∆∞·ªõc m√† ta l√†m sau khi m·ªçi th·ª© ƒë√£ ·ªïn ƒë·ªãnh tr√™n m√†n h√¨nh chu·∫©n [-1; 1] v√† ta ch·ªâ vi·ªác scale n√≥ l√™n k√≠ch th∆∞·ªõc canvas th√¥i.<br/>
                    D·ª±a v√†o 4 √Ω tr√™n, ta mu·ªën c√≥ m·ªôt ma tr·∫≠n P s·∫Ω th·ª±c hi·ªán ƒë∆∞·ª£c ph√©p bi·∫øn ƒë·ªïi sau:
                    $$
                        P * 
                        \begin{pmatrix}
                        x \\
                        y \\
                        z
                        \end{pmatrix}
                        =
                        \begin{pmatrix}
                        x' \\
                        y' \\
                        z'
                        \end{pmatrix}
                        =
                        \begin{pmatrix}
                        (x * \frac{h}{w} * \frac{1}{tan(\frac{Œ∏}{2})})/z \\
                        (y * \frac{1}{tan(\frac{Œ∏}{2})})/z\\
                        (z\frac{z_{far}}{z_{far}-z_{near}} - z_{near}\frac{z_{far}}{z_{far}-z_{near}})/z
                        \end{pmatrix}
                    $$
                    V·ªÅ ph√©p chia cho \(z\), ƒë√≥ l√† ƒëi·ªÅu kh√¥ng th·ªÉ v·ªõi ma tr·∫≠n, cho n√™n ta s·∫Ω ƒë·ªÉ n√≥ sang 1 b√™n v√† t√≠nh nh·ªØng c√°i ·ªü trong tr∆∞·ªõc. ƒê·ªëi v·ªõi \(x'\), n√≥ ch·ªâ ƒë∆°n gi·∫£n l√† 
                    \(x\) nh√¢n v·ªõi g√¨ ƒë√≥, v√† n√≥ c√≥ d·∫°ng \(a_{11}x + a_{12}y + a_{13}z\), cho n√™n ta ch·ªâ c·∫ßn ƒë·ªÉ \(a_{11} = \frac{h}{w} * \frac{1}{tan(\frac{Œ∏}{2})}\) v√† 
                    \(a_{12} = 0, a_{13} = 0\) s·∫Ω ra ƒë∆∞·ª£c l·∫°i bi·ªÉu th·ª©c tr√™n.
                    $$
                        P = 
                        \begin{pmatrix}
                        \frac{h}{w} * \frac{1}{tan(\frac{Œ∏}{2})} & 0 & 0 \\
                        ? & ? & ? \\
                        ? & ? & ?
                        \end{pmatrix}
                    $$
                    ƒê·ªëi v·ªõi \(y\) c≈©ng t∆∞∆°ng t·ª±, n√≥ c√≥ d·∫°ng \(y\) nh√¢n g√¨ ƒë√≥, gh√©p v√†o \(a_{21}x + a_{22}y + a_{23}z\) ta c√≥:
                    $$
                        P = 
                        \begin{pmatrix}
                        \frac{h}{w} * \frac{1}{tan(\frac{Œ∏}{2})} & 0 & 0 \\
                        0 & \frac{1}{tan(\frac{Œ∏}{2})} & 0 \\
                        ? & ? & ?
                        \end{pmatrix}
                    $$
                    ƒê·ªëi v·ªõi \(z\), v·∫•n ƒë·ªÅ tr·ªü n√™n ph·ª©c t·∫°p h∆°n, n√≥ c√≥ d·∫°ng \(a + bz\), √°p d·ª•ng k·ªπ thu·∫≠t c·ªßa \(x\) v√† \(y\) ch·ªâ gi·∫£i quy·∫øt ƒë∆∞·ª£c c·ª•m \(z\frac{z_{far}}{z_{far}-z_{near}}\).
                    C√≤n c·ª•m \(-z_{near}\frac{z_{far}}{z_{far}-z_{near}}\) th√¨ ta ph·∫£i x√†i 1 trick m√† ng∆∞·ªùi ta ƒë√£ nghƒ© ra t·ª´ th·ªùi x∆∞a. ƒê√≥ l√† th√™m m·ªôt chi·ªÅu m·ªõi \(w\) cho vector, ƒë·ªÉ n√≥
                    = 1:
                    $$
                        \begin{pmatrix}
                        x \\
                        y \\
                        z \\
                        1
                        \end{pmatrix}
                    $$
                    C√≤n ma tr·∫≠n th√¨ c≈©ng th√™m m·ªôt h√†ng m·ªôt c·ªôt, v√† ƒë·ªÉ \(-z_{near}\frac{z_{far}}{z_{far}-z_{near}}\) v√†o \(a_{34}\):
                    $$
                        P = 
                        \begin{pmatrix}
                        \frac{h}{w} * \frac{1}{tan(\frac{Œ∏}{2})} & 0 & 0 & 0\\
                        0 & \frac{1}{tan(\frac{Œ∏}{2})} & 0 & 0\\
                        0 & 0 & \frac{z_{far}}{z_{far}-z_{near}} & -z_{near}\frac{z_{far}}{z_{far}-z_{near}}\\
                        ? & ? & ? & ?
                        \end{pmatrix}
                    $$
                    Nh∆∞ v·∫≠y khi t√≠nh \(z'\):
                    $$
                        z' = 0x + 0y + z\frac{z_{far}}{z_{far}-z_{near}} + 1*(-z_{near}\frac{z_{far}}{z_{far}-z_{near}}) = z\frac{z_{far}}{z_{far}-z_{near}} - z_{near}\frac{z_{far}}{z_{far}-z_{near}}
                    $$
                    Quay tr·ªü l·∫°i v·ªõi vi·ªác chia \(z\) m√† ta ƒë√£ b·ªè qua m·ªôt b√™n, l√∫c n√†y ta s·∫Ω ƒë·ªÉ \(z\) v√†o trong \(w'\) ƒë·ªÉ cho n√≥ g·ªçn trong ma tr·∫≠n lu√¥n, l√∫c c·∫ßn ta ch·ªâ c·∫ßn l·∫•y \(x'\), \(y'\), \(z'\) chia
                    \(w'\) l√† xong. ƒê·ªÉ v√†o th√¨ kh√° ƒë∆°n gi·∫£n, ta ch·ªâ c·∫ßn ƒë·ªÉ 1 v√†o trong √¥ \(a_{43}\) ƒë·ªÉ n√≥ gi·ªØ l·∫°i \(z\) cho \(w'\). Nh∆∞ v·∫≠y Projection Matrix c·ªßa ch√∫ng ta s·∫Ω c√≥ d·∫°ng:
                    $$
                        P = 
                        \begin{pmatrix}
                        \frac{h}{w} * \frac{1}{tan(\frac{Œ∏}{2})} & 0 & 0 & 0\\
                        0 & \frac{1}{tan(\frac{Œ∏}{2})} & 0 & 0\\
                        0 & 0 & \frac{z_{far}}{z_{far}-z_{near}} & -z_{near}\frac{z_{far}}{z_{far}-z_{near}}\\
                        0 & 0 & 1 & 0
                        \end{pmatrix}
                    $$
                    <br/>
                    Cu·ªôc h√†nh tr√¨nh to√°n c·ªßa ch√∫ng ta ƒë√£ k·∫øt th√∫c, b√¢y gi·ªù ta s·∫Ω code Projection Matrix v√†o trong file HTML c·ªßa ch√∫ng ta. ƒê·∫ßu ti√™n ta ph·∫£i ƒë·ªãnh nghƒ©a class
                    cho ma tr·∫≠n, v√† vi·∫øt h√†m t·∫°o Projection Matrix d·ª±a v√†o c√°c tham s·ªë m√† ta ƒë√£ bi·∫øt:
                    <pre><code class="language-javascript">class Mat4x4 {
    constructor() {
        this.m = [
            [0, 0, 0, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0]
        ];
    }

    static Projection(fov, h, w, zNear, zFar) {
        let fovMultiplier = 1.0 / Math.tan(fov * 0.5 / 180.0 * Math.PI);
        let matrix = new Mat4x4();
        matrix.m[0][0] = h / w * fovMultiplier;
        matrix.m[1][1] = fovMultiplier;
        matrix.m[2][2] = zFar / (zFar - zNear);
        matrix.m[2][3] = (-zNear * zFar) / (zFar - zNear);
        matrix.m[3][2] = 1.0;
        return matrix;
    }
}
                    </code></pre>
                    Ta c≈©ng c·∫ßn ph·∫£i s·ª≠a l·∫°i class Vector3 v√¨ v·ª´a th√™m m·ªôt component m·ªõi l√† w. L∆∞u √Ω l√† n√≥ v·∫´n l√† vector 3 chi·ªÅu,
                    w ch·ªâ c√≥ t√°c d·ª•ng v·ªÅ m·∫∑t ƒë·∫°i s·ªë, gi√∫p ta t√≠nh to√°n d·ªÖ h∆°n, ch·ª© kh√¥ng c√≥ nghƒ©a l√† n√≥ l√† vector 4 chi·ªÅu, v√¨ v·∫≠y c√°c h√†m li√™n quan
                    t·ªõi vector v·∫´n gi·ªØ nguy√™n. Ngo√†i ra ta ph·∫£i th√™m h√†m nh√¢n ma tr·∫≠n v·ªõi vector.
                    <pre><code class="language-javascript">class Vector3 {
    constructor(x = 0, y = 0, z = 0, w = 1) {   //m·∫∑c ƒë·ªãnh w = 1 ƒë·ªÉ tr√°nh chia cho 0
        this.x = x;
        this.y = y;
        this.z = z;
        this.w = w;
    }

    clone() {
        return new Vector3(this.x, this.y, this.z, this.w);
    }

    static add(vec1, vec2) {
        return new Vector3(vec1.x + vec2.x, vec1.y + vec2.y, vec1.z + vec2.z);
    }
    static sub(vec1, vec2) {
        return new Vector3(vec1.x - vec2.x, vec1.y - vec2.y, vec1.z - vec2.z);
    }
    static mul(vec, value) {
        return new Vector3(vec.x * value, vec.y * value, vec.z * value);
    }
    static div(vec, value) {
        return new Vector3(vec.x / value, vec.y / value, vec.z / value);
    }
    static scale(vec1, vec2) {
        return new Vector3(vec1.x * vec2.x, vec1.y * vec2.y, vec1.z * vec2.z);
    }
    static dot(v1, v2) {
        return v1.x * v2.x + v1.y * v2.y + v1.z * v2.z;
    }
    static cross(v1, v2) {
        let v = new Vector3(
            v1.y * v2.z - v1.z * v2.y,
            v1.z * v2.x - v1.x * v2.z,
            v1.x * v2.y - v1.y * v2.x);
        return v;
    }
    magnitude() {
        return Math.hypot(this.x, this.y, this.z);
    }
    normalize() {
        let length = this.magnitude();
        if (length === 0)
            return this;
        this.x /= length;
        this.y /= length;
        this.z /= length;
        return this;
    }

    mulMat4x4(m) {
        // l∆∞u l·∫°i c√°c gi√° tr·ªã ban ƒë·∫ßu d√πng ƒë·ªÉ t√≠nh
        let x = this.x;
        let y = this.y;
        let z = this.z;
        let w = this.w;
        this.x = m.m[0][0] * x + m.m[0][1] * y + m.m[0][2] * z + m.m[0][3] * w;
        this.y = m.m[1][0] * x + m.m[1][1] * y + m.m[1][2] * z + m.m[1][3] * w;
        this.z = m.m[2][0] * x + m.m[2][1] * y + m.m[2][2] * z + m.m[2][3] * w;
        this.w = m.m[3][0] * x + m.m[3][1] * y + m.m[3][2] * z + m.m[3][3] * w;
    }
}</code></pre>

                    ·ªû kh√∫c render, ta t·∫°o projection matrix theo tham s·ªë ta ch·ªçn, nh√¢n t·ª´ng ƒë·ªânh m·ªôt v·ªõi projection matrix, v√† chia cho z c≈© (b√¢y gi·ªù l√† w),
                    sau ƒë√≥ nh√¢n cho k√≠ch th∆∞·ªõc canvas ƒë·ªÉ render:
                    <pre><code class="language-javascript">let znear = 0.01, zfar = 1000;
let projectionMatrix = Mat4x4.Projection(fov, canvas.height, canvas.width, znear, zfar);

let cube1 = makeCube(new Vector3(0.6, -0.7, 2.5), new Vector3(0.7, 0.7, 0.7));
for (let tri of cube1) {
    let vertices = tri.vertices;
    for (let i = 0; i < vertices.length; i++) {
        vertices[i].mulMat4x4(projectionMatrix);
        vertices[i] = Vector3.div(vertices[i], vertices[i].w);
        vertices[i] = new Vector3(
            vertices[i].x * canvas.width + canvas.width / 2,
            -vertices[i].y * canvas.height + canvas.height / 2,
            1);
    }
    ...
}</code></pre>
                    Full code hi·ªÉn th·ªã (n√≥ ph·∫£i gi·ªëng h·ªát l√∫c c≈©):
                    <div class="htmlPreview" id="htmlPreview8"></div>
                    Nh∆∞ v·∫≠y ta ƒë√£ x·ª≠ l√Ω xong Projection Matrix üò≥ Blog sau m√¨nh s·∫Ω n√≥i ti·∫øp v·ªÅ Model Matrix.
                    <div id="graphics3D-nav-bottom"></div>
                </div>

            </div>
        </div>
    </main>

    <footer></footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

    <script src="graphics3D.js"></script>
    <script src="/js/loadsidebar.js"></script>
</body>

</html>